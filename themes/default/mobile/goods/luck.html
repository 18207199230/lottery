<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script type="text/javascript" src="__PUBLIC__/js/fontsize.js"></script>
    <link href="__PUBLIC__/jquery-weui/dist/lib/weui.min.css" type="text/css" rel="Stylesheet"/>
    <link href="__PUBLIC__/jquery-weui/dist/css/jquery-weui.min.css" type="text/css" rel="Stylesheet"/>
    <link rel="stylesheet" href="__PUBLIC__/view_res/mobile/css/alert.css" type="text/css">
    <link rel="stylesheet" href="__PUBLIC__/act/luck/css/base.css">
    <script src="__PUBLIC__/js/jquery/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="__PUBLIC__/jquery-weui/dist/js/jquery-weui.min.js"></script>
    <script type="text/javascript" src="__PUBLIC__/jquery-weui/dist/js/jquery-weui.js"></script>
    <title>幸运购</title>
    <style>
        body {
            background: #980202;
        }

        .bg-info {
            background: url('__PUBLIC__/act/luck/images/bg.png') no-repeat;
            padding-top: 45%;
            padding-bottom: 50%;
        }

        .luck-lottery {
            position: absolute;
            margin-top: 50%;
            z-index: 101;
        }
    </style>
</head>

<body>
<div class="luck-con">
    <div class="luck-show none">
        <div class="weui_mask weui_mask_visible"></div>
        <div class="luck-lottery" style="">
            <div class="game-content">
                <img src="__PUBLIC__/act/luck/images/2p.png">
                <div class="game-goods-wrap">
                    <div class="game-goods-list">
                        <div class="game-goods" style="background: #ffffff;">
                            <div class="game-goods-box" id="game1">
                                <ul class="game-goods-ul" style="">

                                </ul>
                            </div>
                        </div>
                        <div class="game-goods" style="background: #ffffff;">
                            <div class="game-goods-box" id="game2">
                                <ul class="game-goods-ul" style="">

                                </ul>
                            </div>
                        </div>
                        <div class="game-goods" style="background: #ffffff;">
                            <div class="game-goods-box" id="game3">
                                <ul class="game-goods-ul">

                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <a class="game-rule" href="javascript:void(0);" style="display: none;"></a>
                <!-- <span class="game-btn"></span> -->
                <a class="game-prize" href="javascript:void(0);"></a>
            </div>
            <div class="weui_opr_area" style="background: #980202;">
                <p class="weui_btn_area">
                    <!-- href="{:url('mobile/goods/luck',array('id'=>$goods.goods_id))}" -->
                    <a class="weui_btn weui_btn_primary" id="bug_again">再嗨一次</a>
                </p>
            </div>
        </div>

    </div>
    <nav>
        <a href="javascript:window.history.go(-1)" onclick="">返回</a>
    </nav>
    <div class="luck-cen">
        <div class="flex-col-center luck-cen-gl">
            <p>本次中奖概率</p>
            <p id="percentage">0.10%</p>
        </div>
        <div class="flex-row-center luck-cen-btnBox">
            <input type="button" att="1" value="1元嗨" class="selected">
            <input type="button" att="3" value="x3倍">
            <input type="button" att="5" value="x5倍">
        </div>
        <div class="flex-row luck-cen-bottom">
            <img src="IMG_ROOT{$goods.image}" alt="">
            <div class="flex-col-center">
                <input type="hidden" id="pay_mount" value="1.01">
                <input type="hidden" id="original-price" value="{$goods.price}">
                <input type="hidden" id="subject-price" value="{$goods.name}">
                <p class="prices">抽奖价:<span>￥<em id="pay_value">1</em></span></p>
                <p class="original-price">￥{$goods.price}</p>
            </div>

        </div>
    </div>
    <p class="luck-p">采用绝对公平公开的算法</p>
    <input class="luck-btn" id="jindou-payment-btn" type="button" value="金豆支付">
    <input class="luck-btn" id="wechat-payment-btn" type="button" value="微信支付">
</div>
</body>
{block name="script"}
<script>
    //抽奖***********************************************************start
    $(function () {
        var $isLottery = "{$isLottery}";
        var order_no = "{$order_no}";
        var recordSum = "{$recordSum}";
        if (order_no != 0) {
            $(".luck-show").show();
            luck_lottery($isLottery)
        }

        function luck_lottery(isLottery) {
            var is_win = 0
            if (isLottery) {
                gameLen = 1;
                is_win = 1;
            } else {
                is_win = 0;
                gameLen = 10;
            }
            $.luckGame({
                'zj_arr': {
                    'is_win': is_win,
                    'number': 9 //从0算起，就是10了
                },
                gameLen: gameLen, //产品抽奖数量，
                game_pagesize: 10
            });
            $(".game-btn").click();
            $('#bug_again').on('click', function () {
                $(".luck-show").hide();

            })
        }

        //抽奖*********************************************************end
        var num = randomShu();
        var originalPrice = $('#original-price').val();
        $('.luck-cen-btnBox input').on('click', function () {
            $(this).siblings().removeClass('selected');
            $(this).addClass('selected');
            var att = $(this).attr('att');
            p(num * att);
        });

        function randomShu() {
            return (Math.random() * (0.6) + 0.8);
        }

        p(num);

        function p(num) {
            $("#pay_mount").val(num.toFixed(2));
            $("#pay_value").text(num.toFixed(2));
            $('#percentage').text((Number(num) / Number(originalPrice) * 100).toFixed(2) + '%');
        }

        $('#jindou-payment-btn').click(jindouPayCall);

        /**
         * 发起金豆支付
         * @returns {undefined}
         */
        function jindouPayCall() {
            //需要配送的，判断收货地址是否已经获取
            var pay_mount = $('#pay_mount').val();
            var subject = $('#subject-price').val();
            var gid = '{$goods["goods_id"]}';

            $('#balance-payment-btn').addClass('disable').html('支付发起中...');

            $.post("{:url('lottery_payment/balance_pay')}", {
                    'pay_total': pay_mount,
                    'subject': subject,
                    'attach': '2',
                    'gid': gid,
                },
                function (r) {
                    if (r.error) {
                        alert(r.error);
                        $('#balance-payment-btn').removeClass('disable').html('金豆支付');
                        return;
                    }
                    if (r.ret_code === 0) {
                    } else if (r.ret_code === 11) {
                        $('#balance-payment-btn').removeClass('disable').html('金豆支付');
                        alert(r.ret_msg);
                    } else {
                        $(".luck-show").show();
                        luck_lottery(r.isLottery)
                    }
                });
        }
    })
</script>
<!-- 微信JSSDK -->
<script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<!-- 微信JSSDK -->
<script type="text/javascript">
    '{if condition="in_wechat()"}'
    wx.config({
        debug: false,
        appId: '{$signPackage.appId}',
        timestamp: '{$signPackage.timestamp}',
        nonceStr: '{$signPackage.nonceStr}',
        signature: '{$signPackage.signature}',
        jsApiList: [
            'checkJsApi',
            'onMenuShareTimeline',
            'onMenuShareAppMessage',
            'onMenuShareQQ',
            'onMenuShareWeibo',
            'onMenuShareQZone',
            'hideMenuItems',
            'showMenuItems',
            'hideAllNonBaseMenuItem',
            'showAllNonBaseMenuItem',
            'translateVoice',
            'startRecord',
            'stopRecord',
            'onVoiceRecordEnd',
            'playVoice',
            'onVoicePlayEnd',
            'pauseVoice',
            'stopVoice',
            'uploadVoice',
            'downloadVoice',
            'chooseImage',
            'previewImage',
            'uploadImage',
            'downloadImage',
            'getNetworkType',
            'openLocation',
            'getLocation',
            'hideOptionMenu',
            'showOptionMenu',
            'closeWindow',
            'scanQRCode',
            'chooseWXPay',
            'openProductSpecificView',
            'addCard',
            'chooseCard',
            'openCard',
            'chooseWXPay'
        ]
    });
    wx.ready(function () {
        wx.onMenuShareAppMessage({
            title: '好友邀请',
            desc: '老铁，快来嗨一把',
            link: "http://{$_SERVER['HTTP_HOST']}{:url('mobile/goods/luck',array('id'=>$goods['goods_id']))}",
            //&home_id=.$home_id.&sign=.$homeInfo[sign]
            imgUrl: "http://{$_SERVER['HTTP_HOST']}IMG_ROOT{$goods.image}",
            trigger: function (res) {
                // 不要尝试在trigger中使用ajax异步请求修改本次分享的内容，因为客户端分享操作是一个同步操作，这时候使用ajax的回包会还没有返回
                //                    alert('用户点击发送给朋友');
            },
            success: function (res) {
                //                    alert('已分享');
            },
            cancel: function (res) {
                //                    alert('已取消');
            },
            fail: function (res) {
                alert(JSON.stringify(res));
            }
        });

        // 2.2 监听“分享到朋友圈”按钮点击、自定义分享内容及分享结果接口
        //            document.querySelector('#juantuijian').onclick = function () {
        wx.onMenuShareTimeline({
            title: '好友邀请',
            desc: '老铁，快来嗨一把',
            link: "http://{$_SERVER['HTTP_HOST']}{:url('mobile/goods/luck',array('id'=>$goods['goods_id']))}",
            imgUrl: "http://{$_SERVER['HTTP_HOST']}IMG_ROOT{$goods.image}",
            trigger: function (res) {
                // 不要尝试在trigger中使用ajax异步请求修改本次分享的内容，因为客户端分享操作是一个同步操作，这时候使用ajax的回包会还没有返回
                //                    alert('用户点击分享到朋友圈');
            },
            success: function (res) {
                //                    alert('已分享');
            },
            cancel: function (res) {
                //                    alert('已取消');
            },
            fail: function (res) {
                alert(JSON.stringify(res));
            }
        });
        wx.hideMenuItems({
            menuList: [
                "menuItem:exposeArticle",
                "menuItem:share:qq",
                "menuItem:copyUrl",
                "menuItem:share:QZone",
                "menuItem:originPage",
                "menuItem:openWithQQBrowser",
                "menuItem:openWithSafari",
                "menuItem:share:email",
                'menuItem:copyUrl' // 复制链接
            ] // 要隐藏的菜单项，只能隐藏“传播类”和“保护类”按钮，所有menu项见附录3
        });
    });
    '{/if}'
    /**
     * 发起微信支付
     */
    $('#wechat-payment-btn').click(wepayCall);
    var order_no = '';

    /**
     * 发起微信支付
     * @returns {undefined}
     */
    function wepayCall() {
        //需要配送的，判断收货地址是否已经获取
        var pay_mount = $('#pay_mount').val();
        var subject = $('#subject-price').val();
        var gid = '{$goods["goods_id"]}';

        $('#wechat-payment-btn').addClass('disable').html('支付发起中...');

        $.post("{:url('lottery_payment/weixin_pay')}", {
                'pay_total': parseInt(pay_mount),
                'subject': subject,
                'gid': gid,
                'attach': '2',
            },
            function (r) {
                if (r.error) {
                    $.toast(r.error, "forbidden");
                    return;
                }
                if (r.ret_code === 0) {
                    if (r.bizPackage.package !== 'prepay_id=') {
                        // 支付操作成功
                        r.bizPackage.success = wepayCallback;
                        // 支付操作取消
                        r.bizPackage.cancel = wepayCancel;
                        // 支付操作出错
                        r.bizPackage.fail = wepayError;
                        // 发起微信支付
                        order_no = r.out_trade_no;
                        wx.chooseWXPay(r.bizPackage);
                        // 按钮恢复
                        $('#wechat-payment-btn').removeClass('disable').html('微信支付');
                    } else {
                        wepayError();
                    }
                } else if (r.ret_code === 11) {
                    $('#wechat-payment-btn').removeClass('disable').html('微信支付');
                    alert('订单创建失败！' + r.ret_msg);
                }
            });
    }

    /**
     * 微信支付回调
     * @param {type} res
     * @returns {undefined}
     */
    function wepayCallback(res) {
        if (res.errMsg == "chooseWXPay:ok") {
            location.href = "{:url('mobile/goods/luck',array('id'=>$goods['goods_id']))}&order_no=" + order_no;

            $('#wechat-payment-btn').removeClass('disable').html('微信支付');
        } else {
            alert(res.errMsg);
        }

    }

    /**
     * 微信支付失败
     */
    function wepayError() {
        // 按钮恢复
        $('#wechat-payment-btn').removeClass('disable').html('微信安全支付');
    }

    /**
     * 微信支付手动取消
     */
    function wepayCancel() {
        // 按钮恢复
        $('#wechat-payment-btn').removeClass('disable').html('微信安全支付');
    }
</script>
<script type="text/javascript" src="__PUBLIC__/act/luck/js/jquery.min.js"></script>
<script type="text/javascript">
    $.extend({
        luckGame: function (options) {
            var defaults = {
                'gameLen': '15',
                'game_pagesize': 10, //生成多少圈同样的东西
                'zj_arr': { //中奖数组，第一个表示是否中奖，第二个中奖号码
                    'is_win': 1,
                    'number': 17
                }
            };
            var settings = $.extend(defaults, options);
            w_config = {
                'w': $(window).width(),
                'h': $(window).height()
            }
            var gameArr = [];
            var gameLen = settings.gameLen;
            var game_list_h = '';
            var game_init = [];
            var game_list_item_h = 0;

            //每次进来随机3个数字，来启动当前的选择的状态
            for (var i = 0; i < 3; i++) {

                game_init.push(Math.floor(Math.random() * gameLen));
            }
            createGame();
            $(window).resize(function () {

                createGame();
            })

            function createGame() {
                getHeight();
                setLi();
                pushLi(gameArr);
                start();
            }


            function getHeight() {
                w_config = {
                    'w': $(window).width(),
                    'h': $(window).height()
                }
                game_list_item_h = (w_config.w * 320 / 750 * 0.5 * 0.7).toFixed(2);
            }


            //设置奖品
            function setLi() {

                for (var j = 1; j <= settings.game_pagesize; j++) {
                    for (var i = 1; i <= 10; i++) {
                        gameArr.push({
                            'type': j,
                            'index': i,
                            'src': '__PUBLIC__/act/luck/images/' + i + '.jpg'
                        });
                    }
                }


            }

            //写入，初始化奖品的滚动
            function pushLi(arr) {
                console.log(game_list_item_h);
                var html_str = '';
                for (var i = 0; i < arr.length; i++) {
                    html_str += '<li style="height:' +
                        game_list_item_h +
                        'px" data-index="' +
                        arr[i]['index'] +
                        '" data-type="' +
                        arr[i]['type'] +
                        '"><img src="' +
                        arr[i]['src'] +
                        '"></li>';
                }
                $(".game-goods-ul").each(function (e) {
                    $(this).empty().append(html_str);
                    game_list_h = $(this).height();
                    console.log('game_list_item_h', game_init);
                    y = game_list_item_h * game_init[e];

                    $(this).css({
                        'transition-duration': '0ms',
                        'transform': 'translate(0px, -' + y + 'px) translateZ(0px)'
                    })
                });


            }

            function start() {
                // $(".game-btn").click(function() {

                //如果中奖
                if (settings.zj_arr.is_win == 1) {

                    $(".game-goods-ul").each(function (e) {

                        setTimeout(function () {
                            y = (settings.zj_arr.number + settings.gameLen * (settings.game_pagesize - 1)) *
                                game_list_item_h;
                            $(".game-goods-ul").eq(e).css({
                                'transition-duration': '5000ms',
                                'transform': 'translate(0px, -' + y + 'px) translateZ(0px)'
                            })
                        }, e * 300);
                        //判断最后面是否完毕
                        $("#game3").find(".game-goods-ul").on("webkitTransitionEnd", function () {
                            y = settings.zj_arr.number * game_list_item_h;
                            $(".game-goods-ul").css({
                                'transition-duration': '0ms',
                                'transform': 'translate(0px, -' + y + 'px) translateZ(0px)'
                            })
                            $("#game3").find(".game-goods-ul").unbind("webkitTransitionEnd");
                        })
                    })

                } else {

                    numrand = randNum2();
                    console.log(numrand);
                    //不中奖的时候
                    $(".game-goods-ul").each(function (e) {
                        y2 = (numrand[0]) * game_list_item_h;
                        y3 = (numrand[1]) * game_list_item_h;
                        y4 = (numrand[2]) * game_list_item_h;
                        setTimeout(function () {
                            y = (numrand[e] + settings.gameLen * (settings.game_pagesize - 1)) * game_list_item_h;
                            $(".game-goods-ul").eq(e).css({
                                'transition-duration': '5000ms',
                                'transform': 'translate(0px, -' + y + 'px) translateZ(0px)'
                            })
                        }, e * 300);
                        //判断最后面是否完毕
                        $("#game3").find(".game-goods-ul").on("webkitTransitionEnd", function () {

                            $(".game-goods-ul").eq(2).css({
                                'transition-duration': '00ms',
                                'transform': 'translate(0px, -' + y4 + 'px) translateZ(0px)'
                            })
                            $("#game3").find(".game-goods-ul").unbind("webkitTransitionEnd");
                        })
                        $("#game2").find(".game-goods-ul").on("webkitTransitionEnd", function () {

                            $(".game-goods-ul").eq(1).css({
                                'transition-duration': '00ms',
                                'transform': 'translate(0px, -' + y3 + 'px) translateZ(0px)'
                            })
                            $("#game2").find(".game-goods-ul").unbind("webkitTransitionEnd");
                        })
                        $("#game1").find(".game-goods-ul").on("webkitTransitionEnd", function () {

                            $(".game-goods-ul").eq(0).css({
                                'transition-duration': '00ms',
                                'transform': 'translate(0px, -' + y2 + 'px) translateZ(0px)'
                            })
                            $("#game1").find(".game-goods-ul").unbind("webkitTransitionEnd");
                        })
                    })

                }


                // })
            }

            function randNum2() {
                a = Math.floor(Math.random() * gameLen);
                b = Math.floor(Math.random() * gameLen);
                c = Math.floor(Math.random() * gameLen);
                arr = [];
                if (a == b) {
                    return randNum2();
                } else {
                    return arr = [a, b, c];
                }
            }
        }
    })
</script>
{/block}

</html>