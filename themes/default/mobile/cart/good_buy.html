{extend name="public:base" /} {block name="jquery"}
<script src="__PUBLIC__/jquery-weui/dist/lib/jquery-2.1.4.js"></script>
{/block} {block name="head"}
<link href="__PUBLIC__/view_res/mobile/css/cart.css" type="text/css" rel="Stylesheet" />
<link href="__PUBLIC__/jquery-weui/dist/lib/weui.min.css" type="text/css" rel="Stylesheet" />
<link href="__PUBLIC__/jquery-weui/dist/css/jquery-weui.min.css" type="text/css" rel="Stylesheet" />
<link rel="stylesheet" href="__PUBLIC__/view_res/mobile/css/alert.css" type="text/css">
<link rel="stylesheet" href="__PUBLIC__/view_res/mobile/css/draw.css" type="text/css">
<script src="__PUBLIC__/jquery-weui/dist/lib/fastclick.js"></script>
<script src="__PUBLIC__/jquery-weui/dist/js/jquery-weui.min.js"></script>
<script src="__PUBLIC__/jquery-weui/dist/js/city-picker.js"></script>
<script src="__PUBLIC__/js/jquery/jquery-migrate-1.2.1.min.js"></script>
<script src="__PUBLIC__/artTemplate/template.js"></script>
<script src="__PUBLIC__/view_res/mobile/load_list.js"></script>

<script src="__PUBLIC__/js/draw/underscore.js"></script>

<script src="__PUBLIC__/js/draw/boot-modal.js"></script>
<script src="__PUBLIC__/js/draw/snow-plugin.js"></script>
<script src="__PUBLIC__/js/draw/pc_draw.js"></script>
{/block} {block name="header"} {include file="public/top-nav" /} {/block} {block name="content"}
<header class="Thead">订单信息</header>

<div id="orderDetailsWrapper" data-minheight="68px">
    <section class="cartListWrap clearfix" id="">

        <a href="{:url('goods/detail',array('id'=>$goods.goods_id))}"><img alt="{$goods.name}" src="IMG_ROOT{$goods.image}" /></a>

        <div class="cartListDesc">
            <p class="title">
                <a style="color:#000;" href="{:url('goods/detail',array('id'=>$goods.goods_id))}">{$goods.name}</a>
            </p>
            <p class="count">
                {notempty name="homeInfo['home_name']"} 房间名：{$homeInfo['home_name']}
                <br> {/notempty} 商品总价：&yen;
                <span class="dprice prices" id="prices">{$goods.price}
                </span>
            </p>
            <dl id="select_number" class="pd-dsc clearfix">
                <span style="font-size: 14px;">购买份额：</span>
                <dt class="productCount clearfix">
                    <a id="productCountMinus" class="btn productCountMinus"></a>
                    <span class="productCountNum">
                        <input minimum='1' id="quantity" size="5" type='number' value='1'
                               class="dcount productCountNumi" onkeyup="value=value.replace(/[^\d]/g,'') "
                               onbeforepaste="clipboardData.setData('text',clipboardData.getData('text').replace(/[^\d]/g,''))"/>
                    </span>
                    <a id="productCountPlus" class="btn productCountPlus"></a>
                </dt>
            </dl>
            <div class="fsc12 flex-between">
                <div style="line-height: 1.5rem;">中奖概率为：<span id="probability">0%</span></div>
                <input type="button" value="包尾" class="payment1" id="package_tail">
            </div>
        </div>
        <div class="weui_progress pregress">
            <div class="weui_progress_bar">
                <div class="weui_progress_inner_bar js_progress" style="width: {$percentage};"></div>
            </div>
        </div>
        <div class="flex-between fs12">
            <p>满<span id="share">{$homeInfo.lottery_drifts}</span>份次开奖</p>
            <p>剩余<span id="remain">{$homeInfo.lottery_drifts-$homeInfo.goods_buy_num}</span></p>
        </div>
        <!-- <div class="weui_btn_area">
            <a style="font-weight:bold" class="weui_btn weui_btn_primary payment" id="package_tail">包尾</a>
        </div> -->
    </section>
</div>
<!-- 订单总额 -->
<div id="orderSummay">
    <div>
        <input type="hidden" id="subject" value="{$goods.name}">
        <input type="hidden" id="pay_mount" value="1"> 购买金额 :
        <b class="prices"> &yen;</b>
        <b class="prices font13 last" id="order_amount_sig">1</b>
    </div>
    <!--<div>-->
    <!--总计 : <b class="prices"> &yen;</b> <b class="prices last" id="order_amount">2342</b>-->
    <!--</div>-->

</div>
<div id="yanhua" class="none">
    <div id="lottery-main" class="lottery-main">
        <div class="wrap-main">
            <div class="lottery-wrap" id="lottery-wrap">

                <div class="clearfix lottery-list" data-id="" data-namezh="3630" data-nameen="avatar1">
                    <div class="f-l lottery-content">

                        <div class="content-detail">
                            <b>抽奖号码：</b>
                            <span>3 6 3 0</span>
                        </div>
                    </div>
                </div>
                <div class="clearfix lottery-list" data-id="" data-namezh="1693" data-nameen="avatar46">
                    <div class="f-l lottery-content">

                        <div class="content-detail">
                            <b>抽奖号码：</b>
                            <span>1 6 9 3</span>
                        </div>
                    </div>
                </div>
                <div class="clearfix lottery-list" data-id="" data-namezh="1693" data-nameen="avatar46">
                    <div class="f-l lottery-content">

                        <div class="content-detail">
                            <b>抽奖号码：</b>
                            <span>1 6 9 3</span>
                        </div>
                    </div>
                </div>
                <div class="clearfix lottery-list" data-id="" data-namezh="3630" data-nameen="avatar1">
                    <div class="f-l lottery-content">

                        <div class="content-detail">
                            <b>抽奖号码：</b>
                            <span>3 6 3 0</span>
                        </div>
                    </div>
                </div>
                <div class="clearfix lottery-list" data-id="" data-namezh="1693" data-nameen="avatar46">
                    <div class="f-l lottery-content">

                        <div class="content-detail">
                            <b>抽奖号码：</b>
                            <span>1 6 9 3</span>
                        </div>
                    </div>
                </div>
                <div class="clearfix lottery-list" data-id="" data-namezh="1693" data-nameen="avatar46">
                    <div class="f-l lottery-content">

                        <div class="content-detail">
                            <b>抽奖号码：</b>
                            <span>1 6 9 3</span>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!--抽奖按钮-->
        <div class="dashboard">
            <div class="cirle-btn award none" id="award-1" data-award="1">一</div>
            <div class="cirle-btn award none" id="award-2" data-award="2">二</div>
            <div class="btn btn-red-outline lottery-btn none" id="lottery-btn" data-award="2">点击开始</div>
            <div class="cirle-btn award none" id="award-3" data-award="3">三</div>
            <div class="cirle-btn award award-active none" id="award-4" data-award="4">纪</div>
        </div>
    </div>

    <!-- 中奖弹框 -->
    <!--倒计时展示-->
    <div class="stop-main" style="line-height: calc(100%);">
        <div id="stop-time">叁</div>
        <div class="back"></div>
    </div>
    <button class="close" id="modal-close" data-dismiss="modal" style="visibility: hidden;">
            <span aria-hidden="true" class="btn_x">&times;</span>
        </button>
    <div class="modal fade" id="lottery-result" role="dialog" aria-hidden="true">
        <canvas id="canvas"></canvas>
        <div class="modal-dialog">
            <div class="modal-content" style="height: calc(100% - 40px);padding-top: 40px;">
                <canvas id="lottery-canvas"></canvas>
            </div>
        </div>
    </div>
    <!-- 中奖者数据展示模板 start -->
    <script type="text/template" id="awardcon-tpl">
        <li class="clearfix win-li">
            <div class="avatar">
            </div>
            <div class="name">中奖名称</div>
            <a class="f-l delete" href="javascript:;">&times;</a>
        </li>
    </script>
    <!-- 中奖者数据展示模板 end -->

    <!--音乐开关-->
    <a id="music-control" class="animated infinite bounce" href="javascript:;" data-open="1"></a>
    <!--清除数据开关-->
    <a id="clear-control" href="javascript:;" data-open="1"></a>

    <audio id="music" loop preload="auto" src="../../../../public/static/js/draw/shiji.mp3">
            你的浏览器不支持audio标签
        </audio>
</div>
{if condition="in_wechat()"}
<div class="weui_btn_area">
    <a style="font-weight:bold;font-size: 22px;" class="weui_btn weui_btn_primary" id="wechat-payment-btn">微信支付</a>
</div>
{else/}
<!--<div class="weui_btn_area">-->
<!--<a class="weui_btn weui_btn_primary payment" id="alipay-payment-btn">支付宝支付</a>-->
<!--</div>-->
{/if}
<div class="weui_btn_area">
    <a style="font-weight:bold" class="weui_btn weui_btn_primary payment" id="balance-payment-btn">金豆支付</a>
</div>
<script>
    $(function() {
        //支付宝支付
        $('#alipay-payment-btn').click(function() {

            var city_id = $('#city_id').val();
            var address_id = $('#address_id').val();
            var comment = $('#comment').val();

            $.post(
                '{:url("payment/alipay_pay")}', {
                    city_id: city_id,
                    comment: comment,
                    address_id: address_id
                },
                function(d) {

                    if (d.error) {
                        $.toast(d.error, "forbidden");
                    }

                    if (d.url) {
                        location = d.url;
                    }
                }
            );

        });
    });
</script>

{/block} {block name="script"}
<!-- 微信JSSDK -->
<script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script>
    $(function() {
        var goodsNum, prices, share, remain;
        // 减键
        $('#productCountMinus').on('click', function() {
            let goodsNum = $('#quantity').val();

            if (parseInt(goodsNum) > 1) {
                goodsNum = parseInt(goodsNum) - 1;
                changeNum(goodsNum);
            }
        })
        $('#package_tail').on('click', function() {
                remain = $('#remain').text(); //剩余份额
                changeNum(remain);
            })
            // 加键
        $('#productCountPlus').on('click', function() {
            let goodsNum = $('#quantity').val(),
                remain = $('#remain').text(); //剩余份额

            if (parseInt(goodsNum) < parseInt(remain)) {
                goodsNum = parseInt(goodsNum) + 1;
                $('#quantity').val(goodsNum);
                changeNum(goodsNum);
            }
        })
        $('.productCountNumi').change(function() {
            goodsNum = parseInt($(this).val());
            changeNum(goodsNum);
        })

        function changeNum(goodsNum) {
            remain = parseInt($('#remain').text()); //剩余份额
            prices = $('#prices').text(); //总价
            share = parseInt($('#share').text()); //总份额
            if (goodsNum > remain) {
                goodsNum = remain;
                $(this).val(remain);
            }
            if (goodsNum < 1 || goodsNum === "" || goodsNum == null) {
                goodsNum = 1;
                $(this).val(1);
            }
            $('#quantity').val(goodsNum);
            $('#order_amount_sig').text(Number(prices) / Number(share) * Number(goodsNum));
            $('#pay_mount').val(Number(prices) / Number(share) * Number(goodsNum));
            $('#probability').text((Number(goodsNum) / Number(share) * 100).toFixed(2) + '%');
        }

        changeNum(1);
    })
</script>
<!-- 微信JSSDK -->
<script type="text/javascript">
    '{if condition="in_wechat()"}'
    wx.config({
        debug: false,
        appId: '{$signPackage.appId}',
        timestamp: '{$signPackage.timestamp}',
        nonceStr: '{$signPackage.nonceStr}',
        signature: '{$signPackage.signature}',
        jsApiList: [
            'checkJsApi',
            'onMenuShareTimeline',
            'onMenuShareAppMessage',
            'onMenuShareQQ',
            'onMenuShareWeibo',
            'onMenuShareQZone',
            'hideMenuItems',
            'showMenuItems',
            'hideAllNonBaseMenuItem',
            'showAllNonBaseMenuItem',
            'translateVoice',
            'startRecord',
            'stopRecord',
            'onVoiceRecordEnd',
            'playVoice',
            'onVoicePlayEnd',
            'pauseVoice',
            'stopVoice',
            'uploadVoice',
            'downloadVoice',
            'chooseImage',
            'previewImage',
            'uploadImage',
            'downloadImage',
            'getNetworkType',
            'openLocation',
            'getLocation',
            'hideOptionMenu',
            'showOptionMenu',
            'closeWindow',
            'scanQRCode',
            'chooseWXPay',
            'openProductSpecificView',
            'addCard',
            'chooseCard',
            'openCard',
            'chooseWXPay'
        ]
    });
    '{/if}'
    /**
     * 发起微信支付
     */
    $('#wechat-payment-btn').click(wepayCall);
    var home_id = '{:input("home_id")}';
    var gid = '{$homeInfo["gid"]}';
    var order_no = '';

    /**
     * 发起微信支付
     * @returns {undefined}
     */
    function wepayCall() {
        //需要配送的，判断收货地址是否已经获取
        var pay_mount = $('#pay_mount').val();
        var subject = $('#subject').val();
        var goodsNum = $('#quantity').val();;

        $('#wechat-payment-btn').addClass('disable').html('支付发起中...');

        $.post("{:url('lottery_payment/weixin_pay')}", {
                'pay_total': pay_mount,
                'subject': subject,
                'attach': '1',
                'goodsNum': goodsNum,
                'home_id': home_id,
                'gid': gid,
            },
            function(r) {
                if (r.error) {
                    $.toast(r.error, "forbidden");
                    return;
                }
                if (r.ret_code === 0) {
                    if (r.bizPackage.package !== 'prepay_id=') {
                        // 支付操作成功
                        r.bizPackage.success = wepayCallback;
                        // 支付操作取消
                        r.bizPackage.cancel = wepayCancel;
                        // 支付操作出错
                        r.bizPackage.fail = wepayError;
                        // 发起微信支付
                        order_no = r.out_trade_no;
                        wx.chooseWXPay(r.bizPackage);
                        // 按钮恢复
                        $('#wechat-payment-btn').removeClass('disable').html('微信支付');
                    } else {
                        wepayError();
                    }
                } else if (r.ret_code === 11) {
                    $('#wechat-payment-btn').removeClass('disable').html('微信支付');
                    alert('订单创建失败！' + r.ret_msg);
                }
            });


    }

    /**
     * 微信支付回调
     * @param {type} res
     * @returns {undefined}
     */
    function wepayCallback(res) {

        if (res.errMsg == "chooseWXPay:ok") {
            setTimeout(function() {
                location.href = "{:url('mobile/goods/detail',array('id'=>$goods['goods_id']))}";
            }, 1000);
            $('#wechat-payment-btn').removeClass('disable').html('微信支付');
        } else {
            alert(res.errMsg);
        }

    }

    /**
     * 微信支付失败
     */
    function wepayError() {
        cancelOrder(2);
        // 按钮恢复
        $('#wechat-payment-btn').removeClass('disable').html('微信支付');
    }

    /**
     * 微信支付手动取消
     */
    function wepayCancel() {
        cancelOrder(3);
        // 按钮恢复
        $('#wechat-payment-btn').removeClass('disable').html('微信支付');
    }

    function cancelOrder(status) {
        var goodsNum = $('#quantity').val();
        $.post("{:url('lottery_payment/cancel_order')}", {
                'home_id': home_id,
                'gid': gid,
                'order_no': order_no,
                'goodsNum': goodsNum,
                'status': status,
            },
            function(r) {
                if (r.error) {
                    $.toast(r.error, "forbidden");
                    return;
                }
            });
    }
</script>
<!--金豆支付-->
<script type="text/javascript">
    $('#balance-payment-btn').click(wepayCall);
    var home_id = '{:input("home_id")}';
    var gid = '{$homeInfo["gid"]}';
    var lottery_num = '{$lottery_num}';
    var lottery_status = '{$homeInfo["status"]}';

    /**
     * 发起金豆支付
     * @returns {undefined}
     */
    function wepayCall() {
        //需要配送的，判断收货地址是否已经获取
        var pay_mount = $('#pay_mount').val();
        var subject = $('#subject').val();
        var goodsNum = $('#quantity').val();;

        $('#balance-payment-btn').addClass('disable').html('支付发起中...');

        $.post("{:url('lottery_payment/balance_pay')}", {
                'pay_total': pay_mount,
                'subject': subject,
                'attach': '1',
                'goodsNum': goodsNum,
                'home_id': home_id,
                'gid': gid,
            },
            function(r) {
                if (r.error) {
                    $.toast(r.error, "forbidden");
                    $('#balance-payment-btn').removeClass('disable').html('金豆支付');
                    return;
                }
                if (r.ret_code === 0) {} else if (r.ret_code === 11) {
                    $('#balance-payment-btn').removeClass('disable').html('金豆支付');
                    alert(r.ret_msg);
                } else {
                    $.toast('支付成功');
                    setTimeout(function() {
                        location.href = "{:url('mobile/goods/detail',array('id'=>$goods['goods_id']))}";
                    }, 3000);
                }
            });
    }

    //定时检查是否开奖
    var setTime = 3000;

    function checkLottery() {
        $.post("{:url('home/is_full')}", {
                'home_id': home_id,
            },
            function(r) {
                // console.log('r', r);
                if (r.status > 0) {
                    if (r.is_self > 0) {
                        alert('是自己')
                    } else {
                        alert('不是自己')
                    }
                    //这里需要放烟花
                    // alert('开奖啦！中奖号码是' + r.lottery_num);
                    $('#yanhua').fadeIn();
                    //一进来就开始滚动抽奖
                    lottery_btn_fun();

                    setTimeout(() => {
                        lottery_btn_fun();
                    }, 5000);
                    return true;
                } else {
                    setTimeout(checkLottery, setTime);
                }
            });
    }

    if (lottery_status > 0) {
        //这里不需要放烟花
        alert('已开奖，中奖号码是' + lottery_num);
    } else {
        setTimeout(checkLottery, setTime);
    }
</script>

<script>
    // 2. 分享接口
    // 2.1 监听“分享给朋友”，按钮点击、自定义分享内容及分享结果接口
    wx.ready(function() {
        wx.onMenuShareAppMessage({
            title: '好友邀请',
            desc: '老铁，我已经把房开好了，来不来就看你了',
            link: "http://{$_SERVER['HTTP_HOST']}{:url('mobile/cart/good_buy&home_id='.$home_id.'&sign='.$homeInfo['sign'])}",
            //&home_id=.$home_id.&sign=.$homeInfo[sign]
            imgUrl: "http://{$_SERVER['HTTP_HOST']}IMG_ROOT{$goods.image}",
            trigger: function(res) {
                // 不要尝试在trigger中使用ajax异步请求修改本次分享的内容，因为客户端分享操作是一个同步操作，这时候使用ajax的回包会还没有返回
                //                    alert('用户点击发送给朋友');
            },
            success: function(res) {
                //                    alert('已分享');
            },
            cancel: function(res) {
                //                    alert('已取消');
            },
            fail: function(res) {
                alert(JSON.stringify(res));
            }
        });

        // 2.2 监听“分享到朋友圈”按钮点击、自定义分享内容及分享结果接口
        //            document.querySelector('#juantuijian').onclick = function () {
        wx.onMenuShareTimeline({
            title: '好友邀请',
            desc: '老铁，我已经把房开好了，来不来就看你了',
            link: "http://{$_SERVER['HTTP_HOST']}{:url('mobile/cart/good_buy&home_id='.$home_id.'&sign='.$homeInfo['sign'])}",
            imgUrl: "http://{$_SERVER['HTTP_HOST']}IMG_ROOT{$goods.image}",
            trigger: function(res) {
                // 不要尝试在trigger中使用ajax异步请求修改本次分享的内容，因为客户端分享操作是一个同步操作，这时候使用ajax的回包会还没有返回
                //                    alert('用户点击分享到朋友圈');
            },
            success: function(res) {
                //                    alert('已分享');
            },
            cancel: function(res) {
                //                    alert('已取消');
            },
            fail: function(res) {
                alert(JSON.stringify(res));
            }
        });
        wx.hideMenuItems({
            menuList: [
                    "menuItem:exposeArticle",
                    "menuItem:share:qq",
                    "menuItem:copyUrl",
                    "menuItem:share:QZone",
                    "menuItem:originPage",
                    "menuItem:openWithQQBrowser",
                    "menuItem:openWithSafari",
                    "menuItem:share:email",
                    'menuItem:copyUrl' // 复制链接
                ] // 要隐藏的菜单项，只能隐藏“传播类”和“保护类”按钮，所有menu项见附录3
        });
    });
    wx.error(function(res) {
        alert(res.errMsg);
    });
</script>
{/block}